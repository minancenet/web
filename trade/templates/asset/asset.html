{% extends "layouts/layout_no_margin.html" %} {% block content %}

<script src='https://cdn.plot.ly/plotly-latest.min.js'></script>

<div class="tabs">
  <button class="tablink" onclick="openTab(event, 'sell')">Sell Candlestick Chart</button>
  <button class="tablink" onclick="openTab(event, 'buy')">Buy Candlestick Chart</button>
  <button class="tablink">5M <i class="fas fa-chevron-down" style="font-size: 0.6rem;"></i></button>
</div>

<div class="row border-bottom">
  <div class="col-6 border-right">
    <div id="sell" class="tabcontent" style="display: block;">
      <div id="sellChart"></div>
    </div>
    <div id="buy" class="tabcontent">
      <div id="buyChart"></div>
    </div>
  </div>
  <div class="col-6">
    <div id="lineChart"></div>
    <script>
      fetch("http://localhost:5000/api/v1/asset/{{ asset.name }}/price")
      .then(res => res.json())
      .then((out) => {
        var dates = []
        var sell = []
        var buy = []
        
        for (var i = 0; i < out["sell"].length; i++) {
          dates.push(out["sell"][i][0]*1000)
          sell.push(out["sell"][i][1])
        }

        for (var i = 0; i < out["buy"].length; i++) {
          dates.push(out["buy"][i][0]*1000)
          buy.push(out["buy"][i][1])
        }
        
        var trace1 = {
      
          x: dates, 
          y: sell,
          name: "Sell Price",
        
          line: {color: 'rgba(31,119,180,1)'}, 
          fill: 'tozeroy',
  
          type: 'scatter', 
          xaxis: 'x', 
          yaxis: 'y'
        };

        var trace2 = {
          x: dates,
          y: buy,
          name: "Buy Price",

          line: {color: '#7F7F7F'},
          fill: 'tonexty',
            
          type: 'scatter', 
          xaxis: 'x', 
          yaxis: 'y'
        }
    
        var data = [trace1, trace2];

        var layout = {
          dragmode: 'zoom', 
          margin: {
            r: 10, 
            t: 25, 
            b: 40, 
            l: 60
          }, 
          showlegend: false, 
          xaxis: {
            autorange: true, 
            rangeslider: {}, 
            title: 'Date', 
            type: 'date'
          }, 
          yaxis: {
            title: "Price",
            autorange: true, 
            type: 'linear'
          },
          plot_bgcolor: "rgb(0,0,0)",
          paper_bgcolor: "rgb(0,0,0)"
        };

        Plotly.newPlot('lineChart', data, layout);
      })
    </script>
  </div>
</div>
<div class="row border-bottom" style="margin-top: 0;">
  <div class="stats-section">
    <div class="row" style="display: flex;">
      <div class="col-4 border-right">
        <h5 class="section-header">Latest Orders</h5>
        <div class="row">
          <div class="col-6">
            <h5 class="section-subheader">Sell Orders</h5>
            <table class="assets-table alt">
              <tr>
                <th class="letter-td">Unit Price</th>
                <th class="number-td">Amount</th>
                <th class="number-td">Orders</th>
              </tr>
              {% for order in pickle.loads(asset.sellOrders) %}
                <tr>
                  <a href="#"><td class="letter-td">{{ order[1] }}</td></a>
                  <td class="number-td">{{ order[0] }}</td>
                  <td class="number-td">{{ order[2] }}</td>
                </tr>
              {% endfor %}
            </table>            
          </div>
          <div class="col-6">
            <h5 class="section-subheader">Buy Orders</h5>
            <table class="assets-table alt">
              <tr>
                <th class="letter-td">Unit Price</th>
                <th class="number-td">Amount</th>
                <th class="number-td">Orders</th>
              </tr>
              {% for order in pickle.loads(asset.buyOrders) %}
                <tr>
                  <a href="#"><td class="letter-td">{{ order[1] }}</td></a>
                  <td class="number-td">{{ order[0] }}</td>
                  <td class="number-td">{{ order[2] }}</td>
                </tr>
              {% endfor %}
            </table>            
          </div>
        </div>
      </div>
      <div class="col-4 border-right">
        <h5 class="section-header">Statistics</h5>
        <div class="data-table">
          <div class="entry">
            <span class="entry-label">Sell Volume:</span> <span class="entry-data">{{ asset.sellVolume }}</span>
          </div>
          <div class="entry">
            <span class="entry-label">Sell Orders:</span> <span class="entry-data">{{ asset.sellOrderAmount }}</span>
          </div>
          <div class="entry">
            <span class="entry-label">Sell Moving Week:</span> <span class="entry-data">{{ asset.sellMovingWeek }}</span>
          </div>
        </div>
        <div class="data-table">
          <div class="entry">
            <span class="entry-label">Buy Volume:</span> <span class="entry-data">{{ asset.buyVolume }}</span>
          </div>
          <div class="entry">
            <span class="entry-label">Buy Orders:</span> <span class="entry-data">{{ asset.buyOrderAmount }}</span>
          </div>
          <div class="entry">
            <span class="entry-label">Buy Moving Week:</span> <span class="entry-data">{{ asset.buyMovingWeek }}</span>
          </div>
        </div>
      </div>
      <div class="col-4">
        <h5 class="section-header">Trading</h5>
        <form method="POST" action="">
          {{ form.hidden_tag() }}
          <div class="form-group">
            <div class="form-label">
              <p>Purchase Time</p>
            </div>
            <div class="form-field">
              {% if form.purchaseDate.errors %}
              {{ form.purchaseDate(class="invalid") }}
              <div class="invalid-feedback">
                  {% for error in form.purchaseDate.errors %}
                    <span>{{ error }}</span>
                  {% endfor %}
              </div>
            {% else %}
              {{ form.purchaseDate(class="") }}
            {% endif %}
            {% if form.purchaseTime.errors %}
              {{ form.purchaseTime(class="invalid") }}
              <div class="invalid-feedback">
                  {% for error in form.purchaseTime.errors %}
                    <span>{{ error }}</span>
                  {% endfor %}
              </div>
            {% else %}
              {{ form.purchaseTime(class="") }}
            {% endif %}  
            </div>
          </div>
          <div class="clear"></div>
          <div class="form-group">
            <div class="form-label">
              <p>Sell Time</p>
            </div>
            <div class="form-field">
              {% if form.sellDate.errors %}
              {{ form.sellDate(class="invalid") }}
              <div class="invalid-feedback">
                  {% for error in form.sellDate.errors %}
                    <span>{{ error }}</span>
                  {% endfor %}
              </div>
            {% else %}
              {{ form.sellDate(class="") }}
            {% endif %}
            {% if form.sellTime.errors %}
              {{ form.sellTime(class="invalid") }}
              <div class="invalid-feedback">
                  {% for error in form.sellTime.errors %}
                    <span>{{ error }}</span>
                  {% endfor %}
              </div>
            {% else %}
              {{ form.sellTime(class="") }}
            {% endif %}  
            </div>
          </div>
          <div class="clear">
          <div class="form-group" style="margin-top: 1rem;">
            {% if session["margin"] %}
              <div class="trade-output">
                <p>{{ session["margin"] }}</p>
              </div>
            {% endif %}
          </div>
          <div class="form-group form-buttons">
            {% if form.reset.errors %}
              {{ form.reset(class="invalid") }}
              <div class="invalid-feedback">
                  {% for error in form.reset.errors %}
                    <span>{{ error }}</span>
                  {% endfor %}
              </div>
            {% else %}
              {{ form.reset(class="reset-btn") }}
            {% endif %}
            {% if form.check.errors %}
              {{ form.check(class="invalid") }}
              <div class="invalid-feedback">
                  {% for error in form.check.errors %}
                    <span>{{ error }}</span>
                  {% endfor %}
              </div>
            {% else %}
              {{ form.check(class="check-btn") }}
            {% endif %}
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  fetch("http://localhost:5000/api/v1/asset/{{ asset.name }}/ohlc/5.json")
  .then(res => res.json())
  .then((out) => {
    var dates = []
    var o = []
    var h = []
    var l = []
    var c = []
    
    for (var i = 0; i < out["sell"].length; i++) {
      dates.push(out["sell"][i][0]*1000)
      o.push(out["sell"][i][1])
      h.push(out["sell"][i][2])
      l.push(out["sell"][i][3])
      c.push(out["sell"][i][4])
    }
    
    var trace1 = {
  
      x: dates, 
              
      open: o,
      high: h,        
      low: l,
      close: c, 
    
      line: {color: 'rgba(31,119,180,1)'}, 

      type: 'candlestick', 
      xaxis: 'x', 
      yaxis: 'y'
    };
  
    var data = [trace1];

    var layout = {
      dragmode: 'zoom', 
      margin: {
        r: 10, 
        t: 25, 
        b: 40, 
        l: 60
      }, 
      showlegend: false, 
      xaxis: {
        autorange: true, 
        rangeslider: {}, 
        title: 'Date', 
        type: 'date'
      }, 
      yaxis: {
        title: "Sell Price",
        autorange: true, 
        type: 'linear'
      },
      width: 600,
      plot_bgcolor: "rgb(0,0,0)",
      paper_bgcolor: "rgb(0,0,0)"
    };

    var config = {responsive: true}

    Plotly.newPlot('sellChart', data, layout, config);
  })
</script>

<script>
  fetch("http://localhost:5000/api/v1/asset/{{ asset.name }}/ohlc/5.json")
  .then(res => res.json())
  .then((out) => {
    var dates = []
    var o = []
    var h = []
    var l = []
    var c = []

    for (var i = 0; i < out["buy"].length; i++) {
      dates.push(out["buy"][i][0]*1000)
      o.push(out["buy"][i][1])
      h.push(out["buy"][i][2])
      l.push(out["buy"][i][3])
      c.push(out["buy"][i][4])
    }
    
    var trace1 = {
  
      x: dates, 
              
      open: o,
      high: h,        
      low: l,
      close: c, 
    
      line: {color: 'rgba(31,119,180,1)'}, 

      type: 'candlestick', 
      xaxis: 'x', 
      yaxis: 'y'
    };
  
    var data = [trace1];

    var layout = {
      dragmode: 'zoom', 
      margin: {
        r: 10, 
        t: 25, 
        b: 40, 
        l: 60
      }, 
      showlegend: false, 
      xaxis: {
        autorange: true, 
        rangeslider: {}, 
        title: 'Date', 
        type: 'date'
      }, 
      yaxis: {
        title: "Buy Price",
        autorange: true, 
        type: 'linear'
      },
      width: 600,
      plot_bgcolor: "rgb(0,0,0)",
      paper_bgcolor: "rgb(0,0,0)"
    };

    var config = {responsive: true}

    Plotly.newPlot('buyChart', data, layout, config);
  })
</script>

{% endblock content %}